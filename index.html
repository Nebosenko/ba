<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC æœŸæƒå…¨æ™¯çœ‹æ¿ - ç¨³å®šç‰ˆ</title>
    <style>
        :root { --binance-yellow: #f0b90b; --bg: #0b0e11; --card: #1e2329; --call: #0ecb81; --put: #f6465d; --text: #eaecef; --border: #363c4e; }
        body { font-family: "PingFang SC", "Microsoft YaHei", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .header h1 { font-size: 22px; color: var(--binance-yellow); margin: 0; }
        #status { font-size: 12px; color: #848e9c; }

        .loading { text-align: center; margin-top: 50px; color: #848e9c; font-size: 16px; line-height: 1.6; }

        .expiry-section { background: var(--card); border-radius: 8px; margin-bottom: 30px; border: 1px solid var(--border); overflow: hidden; }
        .expiry-header { background: #2b3139; padding: 12px 20px; font-weight: bold; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #161a1e; color: #848e9c; font-size: 12px; font-weight: normal; padding: 10px 5px; text-transform: uppercase; }
        td { padding: 10px 5px; text-align: center; border-bottom: 1px solid #2b3139; font-size: 14px; font-family: "Consolas", monospace; }

        .strike-col { background: #161a1e; font-weight: bold; color: #fff; width: 120px; border-left: 1px solid var(--border); border-right: 1px solid var(--border); }
        .call-side { color: var(--call); text-align: right; padding-right: 15px; }
        .put-side { color: var(--put); text-align: left; padding-left: 15px; }
        .greek { color: #848e9c; font-size: 12px; }
        
        @media (max-width: 600px) { .header h1 { font-size: 18px; } th { font-size: 10px; } td { font-size: 12px; } }
    </style>
</head>
<body>

<div class="header">
    <h1>BTC æœŸæƒå…¨æ™¯çœ‹æ¿</h1>
    <div id="status">å‡†å¤‡åŒæ­¥...</div>
</div>

<div id="main-content">
    <div class="loading">ğŸ“¡ æ­£åœ¨é€šè¿‡ä»£ç†æŠ“å–å¸å®‰æ•°æ®...<br>è¿™å¯èƒ½éœ€è¦ 3-5 ç§’ï¼Œè¯·ç¨å€™ã€‚</div>
</div>

<script>
    async function fetchData() {
        const statusEl = document.getElementById('status');
        try {
            // è¯·æ±‚æ‚¨çš„ Vercel API è·¯ç”±
            const response = await fetch('/api/data');
            let data = await response.json();

            // ä¿®å¤é€»è¾‘ï¼šå¤„ç†ä»£ç†æœåŠ¡å¯èƒ½è¿”å›çš„åŒ…è£…æ ¼å¼ (contents å­—æ®µ)
            if (data && data.contents) {
                data = typeof data.contents === 'string' ? JSON.parse(data.contents) : data.contents;
            }

            // é”™è¯¯æ£€æŸ¥ï¼šå¦‚æœåç«¯è¿”å›äº† error å­—æ®µ
            if (data.error) throw new Error(data.error);

            // å…³é”®ä¿®å¤ï¼šç¡®ä¿ data æœ€ç»ˆæ˜¯ä¸€ä¸ªæ•°ç»„
            const optionsArray = Array.isArray(data) ? data : (data.data || []);
            
            if (!Array.isArray(optionsArray) || optionsArray.length === 0) {
                throw new Error("æ¥æ”¶åˆ°çš„æ•°æ®æ ¼å¼å¼‚å¸¸æˆ–ä¸ºç©º");
            }

            // 1. è¿‡æ»¤ BTC ç›¸å…³çš„æœŸæƒåˆçº¦
            const btcOptions = optionsArray.filter(opt => opt.symbol && opt.symbol.startsWith('BTC-'));

            // 2. æ•°æ®åˆ†ç±»ä¸åˆ†ç»„
            const groups = {};
            btcOptions.forEach(opt => {
                const parts = opt.symbol.split('-'); 
                if (parts.length < 4) return; // è·³è¿‡ä¸ç¬¦åˆæ ¼å¼çš„åˆçº¦

                const expiry = parts[1];
                const strike = parts[2];
                const type = parts[3];

                if (!groups[expiry]) groups[expiry] = {};
                if (!groups[expiry][strike]) groups[expiry][strike] = { C: null, P: null };

                // å…¼å®¹ä¸åŒ API èŠ‚ç‚¹çš„å­—æ®µå‘½å (markIV æˆ– expiryIV)
                const ivValue = opt.markIV || opt.expiryIV || 0;

                groups[expiry][strike][type] = {
                    price: parseFloat(opt.markPrice).toLocaleString(undefined, {minimumFractionDigits: 1}),
                    iv: (parseFloat(ivValue) * 100).toFixed(1) + '%',
                    delta: parseFloat(opt.delta || 0).toFixed(3)
                };
            });

            renderTable(groups);
            statusEl.innerText = 'æœ€ååŒæ­¥: ' + new Date().toLocaleTimeString();

        } catch (error) {
            console.error('Fetch error:', error);
            document.getElementById('main-content').innerHTML = `
                <div class="loading" style="color:#f6465d;">
                    âŒ æ•°æ®å¤„ç†å¤±è´¥: ${error.message}<br>
                    <small>å»ºè®®ï¼šæ£€æŸ¥ api/data.js æ˜¯å¦ä½¿ç”¨äº†æ–¹æ¡ˆ A çš„ä»£ç†ä»£ç ï¼Œå¹¶å°è¯•åˆ·æ–°é¡µé¢ã€‚</small>
                </div>`;
        }
    }

    function renderTable(groups) {
        const container = document.getElementById('main-content');
        container.innerHTML = '';

        // æŒ‰åˆ°æœŸæ—¥å‡åºæ’åˆ—
        const sortedExpiries = Object.keys(groups).sort();

        if (sortedExpiries.length === 0) {
            container.innerHTML = '<div class="loading">æœªæ‰¾åˆ°æœ‰æ•ˆçš„ BTC æœŸæƒæ•°æ®ã€‚</div>';
            return;
        }

        sortedExpiries.forEach(expiry => {
            const section = document.createElement('div');
            section.className = 'expiry-section';

            const formattedDate = `20${expiry.substring(0,2)}-${expiry.substring(2,4)}-${expiry.substring(4,6)}`;
            
            let html = `
                <div class="expiry-header">
                    <span>ğŸ“… åˆ°æœŸæ—¥: ${formattedDate}</span>
                    <span style="color:#848e9c; font-size:12px;">ç»“ç®—: USDT</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Delta</th><th>IV</th><th style="text-align:right">CALL æ ‡è®°ä»·</th>
                                <th class="strike-col">æ‰§è¡Œä»· (Strike)</th>
                                <th style="text-align:left">PUT æ ‡è®°ä»·</th><th>IV</th><th>Delta</th>
                            </tr>
                        </thead>
                        <tbody>`;

            const sortedStrikes = Object.keys(groups[expiry]).sort((a, b) => Number(a) - Number(b));

            sortedStrikes.forEach(strike => {
                const call = groups[expiry][strike]['C'];
                const put = groups[expiry][strike]['P'];

                html += `
                    <tr>
                        <td class="greek">${call ? call.delta : '-'}</td>
                        <td class="greek">${call ? call.iv : '-'}</td>
                        <td class="call-side">${call ? '$' + call.price : '-'}</td>
                        
                        <td class="strike-col">${parseInt(strike).toLocaleString()}</td>
                        
                        <td class="put-side">${put ? '$' + put.price : '-'}</td>
                        <td class="greek">${put ? put.iv : '-'}</td>
                        <td class="greek">${put ? put.delta : '-'}</td>
                    </tr>`;
            });

            html += `</tbody></table></div>`;
            section.innerHTML = html;
            container.appendChild(section);
        });
    }

    fetchData();
    setInterval(fetchData, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
</script>

</body>
</html>