<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC æœŸæƒå…¨æ™¯ç›‘æ§ - ç»ˆæç›´è¿ç‰ˆ</title>
    <style>
        :root { --binance-yellow: #f0b90b; --bg: #0b0e11; --card: #1e2329; --call: #0ecb81; --put: #f6465d; --text: #eaecef; --border: #363c4e; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .header h1 { font-size: 20px; color: var(--binance-yellow); margin: 0; }
        #status { font-size: 12px; color: #848e9c; }
        .loading { text-align: center; margin-top: 50px; color: #848e9c; }
        .expiry-section { background: var(--card); border-radius: 8px; margin-bottom: 30px; border: 1px solid var(--border); overflow: hidden; }
        .expiry-header { background: #2b3139; padding: 12px 20px; font-weight: bold; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #161a1e; color: #848e9c; font-size: 11px; padding: 10px 5px; text-transform: uppercase; }
        td { padding: 10px 5px; text-align: center; border-bottom: 1px solid #2b3139; font-size: 13px; font-family: "Consolas", monospace; }
        .strike-col { background: #161a1e; font-weight: bold; color: #fff; width: 100px; border-left: 1px solid var(--border); border-right: 1px solid var(--border); }
        .call-side { color: var(--call); text-align: right; padding-right: 15px; }
        .put-side { color: var(--put); text-align: left; padding-left: 15px; }
        .greek { color: #848e9c; font-size: 11px; }
        .btn { background: var(--binance-yellow); color: #000; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div class="header">
    <h1>BTC æœŸæƒå…¨æ™¯çœ‹æ¿</h1>
    <div id="status">è¿æ¥ä¸­...</div>
</div>

<div id="main-content">
    <div class="loading">
        ğŸ“¡ æ­£åœ¨å°è¯•é€šè¿‡å¤šä¸ªéš§é“è¿æ¥å¸å®‰æ•°æ®æº...<br>
        å¦‚æœ 10 ç§’å†…æœªå“åº”ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œç¯å¢ƒã€‚
    </div>
</div>

<script>
    // æ–¹æ¡ˆï¼šä½¿ç”¨å…¬å¼€çš„è·¨åŸŸç½‘å…³ï¼Œè·³è¿‡å—é™çš„äº‘æœåŠ¡å™¨ IP
    const PROXY_LIST = [
        "https://api.allorigins.win/get?url=",
        "https://corsproxy.io/?",
        "https://api.codetabs.com/v1/proxy?quest="
    ];

    async function fetchData() {
        const target = "https://eapi.binance.com/eapi/v1/mark";
        const statusEl = document.getElementById('status');
        
        // æˆ‘ä»¬å°è¯•ç¬¬ä¸€ä¸ªæœ€ç¨³çš„ä»£ç†
        const proxyUrl = PROXY_LIST[0] + encodeURIComponent(target);

        try {
            const res = await fetch(proxyUrl);
            const rawData = await res.json();
            
            // AllOrigins åŒ…è£…äº†æ•°æ®åœ¨ .contents å­—æ®µé‡Œ
            let data = typeof rawData.contents === 'string' ? JSON.parse(rawData.contents) : rawData.contents;

            if (!Array.isArray(data)) throw new Error("æ•°æ®æ ¼å¼æ— æ•ˆ");

            const btcOptions = data.filter(opt => opt.symbol.startsWith('BTC-'));
            
            // å½’ç±»é€»è¾‘
            const groups = {};
            btcOptions.forEach(opt => {
                const parts = opt.symbol.split('-'); 
                const [_, expiry, strike, type] = parts;
                if (!groups[expiry]) groups[expiry] = {};
                if (!groups[expiry][strike]) groups[expiry][strike] = { C: null, P: null };

                groups[expiry][strike][type] = {
                    price: parseFloat(opt.markPrice).toFixed(1),
                    iv: (parseFloat(opt.markIV || opt.expiryIV || 0) * 100).toFixed(1) + '%',
                    delta: parseFloat(opt.delta || 0).toFixed(3)
                };
            });

            render(groups);
            statusEl.innerText = 'æ›´æ–°äº: ' + new Date().toLocaleTimeString();
        } catch (e) {
            console.error(e);
            document.getElementById('main-content').innerHTML = `
                <div class="loading" style="color:#f6465d;">
                    âŒ éš§é“è¿æ¥å—é˜»: ${e.message}<br>
                    <small>åŸå› ï¼šæ‚¨çš„æœ¬åœ°ç½‘ç»œå¯èƒ½é™åˆ¶äº†è·¨åŸŸä»£ç†è¯·æ±‚ã€‚</small><br>
                    <button class="btn" onclick="location.reload()">æ‰‹åŠ¨é‡è¯•</button>
                </div>`;
        }
    }

    function render(groups) {
        const container = document.getElementById('main-content');
        container.innerHTML = '';
        const sortedExpiries = Object.keys(groups).sort();

        sortedExpiries.forEach(expiry => {
            const section = document.createElement('div');
            section.className = 'expiry-section';
            const date = `20${expiry.substring(0,2)}-${expiry.substring(2,4)}-${expiry.substring(4,6)}`;
            
            let html = `<div class="expiry-header">ğŸ“… åˆ°æœŸæ—¥: ${date} <span>USDT ç»“ç®—</span></div>
                <div class="table-container"><table>
                <thead><tr><th>Delta</th><th>IV</th><th style="text-align:right">CALL ä»·æ ¼</th><th class="strike-col">æ‰§è¡Œä»·</th><th style="text-align:left">PUT ä»·æ ¼</th><th>IV</th><th>Delta</th></tr></thead>
                <tbody>`;

            const sortedStrikes = Object.keys(groups[expiry]).sort((a, b) => a - b);
            sortedStrikes.forEach(strike => {
                const call = groups[expiry][strike].C;
                const put = groups[expiry][strike].P;
                html += `<tr>
                    <td class="greek">${call?.delta || '-'}</td><td class="greek">${call?.iv || '-'}</td>
                    <td class="call-side">${call ? '$'+call.price : '-'}</td>
                    <td class="strike-col">${parseInt(strike)}</td>
                    <td class="put-side">${put ? '$'+put.price : '-'}</td>
                    <td class="greek">${put?.iv || '-'}</td><td class="greek">${put?.delta || '-'}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
            section.innerHTML = html;
            container.appendChild(section);
        });
    }

    fetchData();
    setInterval(fetchData, 60000);
</script>
</body>
</html>